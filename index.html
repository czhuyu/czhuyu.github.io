<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="无限进步">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="无限进步">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="无限进步">






  <link rel="canonical" href="http://yoursite.com/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>无限进步</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">无限进步</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">do one thing and do it well.</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/31/查找和排序算法/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="czhuyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/26237984">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="无限进步">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/31/查找和排序算法/" class="post-title-link" itemprop="http://yoursite.com/index.html">查找和排序算法</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-31 22:14:07" itemprop="dateCreated datePublished" datetime="2019-05-31T22:14:07+08:00">2019-05-31</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-06-01 00:53:50" itemprop="dateModified" datetime="2019-06-01T00:53:50+08:00">2019-06-01</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="查找和排序算法"><a href="#查找和排序算法" class="headerlink" title="查找和排序算法"></a>查找和排序算法</h2><h4 id="查找算法"><a href="#查找算法" class="headerlink" title="查找算法"></a>查找算法</h4><p>1.顺序查找</p>
<p>2.二分查找</p>
<p>循环实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function midSearch($k,$arr)&#123;</span><br><span class="line">	$left = 0;</span><br><span class="line">	$right = count($arr);</span><br><span class="line">	while($left &lt; $right)&#123;</span><br><span class="line">		$mid = floor(($left + $right)/2);</span><br><span class="line">		if($arr[$mid] == $k)&#123;</span><br><span class="line">			return $mid;</span><br><span class="line">		&#125;else if($arr[$mid] &gt; $k)&#123;</span><br><span class="line">			$right = $mid - 1;</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			$left = $mid + 1;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>递归实现</p>
<h4 id="排序算法"><a href="#排序算法" class="headerlink" title="排序算法"></a>排序算法</h4><p><strong>一.内部排序</strong></p>
<p>先定义一百个0-100整数元素组成的随机数数组和交换函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$n = 100;</span><br><span class="line">$a = [];</span><br><span class="line"></span><br><span class="line">for ($i=0; $i &lt; $n; $i++) &#123; </span><br><span class="line">	$a[] = rand(0,$n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function swap(&amp;$arr,$i,$j)&#123;</span><br><span class="line">	$temp = $arr[$i];</span><br><span class="line">	$arr[$i] = $arr[$j];</span><br><span class="line">	$arr[$j] = $temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1.冒泡排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function bubbleSort($arr)&#123;</span><br><span class="line">	$n = count($arr);</span><br><span class="line">	for($i = 0; $i &lt; $n-1; $i++)&#123;</span><br><span class="line">		for($j = 0;$j &lt; $n-1-$i; $j++)&#123;</span><br><span class="line">			if($arr[$j] &gt; $arr[$j+1])&#123;</span><br><span class="line">				swap($arr,$j,$j+1);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return $arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.选择排序</p>
<p>简单选择排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function selectSort($arr)&#123;</span><br><span class="line">	$n = count($arr);</span><br><span class="line">	for($i = 0; $i &lt; $n-1; $i++)&#123;</span><br><span class="line">		$minKey = $i;</span><br><span class="line">		for($j = $i;$j &lt; $n; $j++)&#123;</span><br><span class="line">			if($arr[$j] &lt; $arr[$minKey])&#123;</span><br><span class="line">				$minKey = $j;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		if($i != $minKey)&#123;</span><br><span class="line">			swap($arr,$i,$minKey);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return $arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>树形选择排序/堆排序</p>
<p>3.插入排序</p>
<p>直接插入排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function insertSort($arr)&#123;</span><br><span class="line">	$n = count($arr);</span><br><span class="line">	for($i = 1; $i &lt; $n; $i++)&#123;</span><br><span class="line">		if($arr[$i] &lt; $arr[$i-1])&#123;</span><br><span class="line">			$temp = $arr[$i];</span><br><span class="line">			$j = $i - 1; </span><br><span class="line">			for($j;$j&gt;=0 &amp;&amp; $arr[$j] &gt; $temp;$j--)&#123;</span><br><span class="line">				$arr[$j+1] = $arr[$j];</span><br><span class="line">			&#125;</span><br><span class="line">			$arr[$j+1] = $temp;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return $arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他插入排序/希尔排序</p>
<p>4.快速排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">function qsort(&amp;$arr, $left, $right)&#123;</span><br><span class="line">	if($left &gt; $right)&#123;</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$i = $left;</span><br><span class="line">	$k = $left;</span><br><span class="line">	$j = $right;</span><br><span class="line"></span><br><span class="line">	while($i &lt; $j)&#123;</span><br><span class="line">		while($arr[$j] &gt;= $arr[$k] &amp;&amp; $i &lt; $j) $j--;</span><br><span class="line">		swap($arr,$j,$k);</span><br><span class="line">		$k = $j;</span><br><span class="line"></span><br><span class="line">		while($arr[$i] &lt;= $arr[$k] &amp;&amp; $i &lt; $j) $i++;</span><br><span class="line">		swap($arr,$i,$k);</span><br><span class="line">		$k = $i;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	qsort($arr, $left, $k-1);</span><br><span class="line">	qsort($arr, $k+1, $right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$n = count($a);</span><br><span class="line">qsort($a, 0, $n-1);</span><br></pre></td></tr></table></figure>
<p>5.归并排序</p>
<p>6.基数排序</p>
<p>多关键字排序/链式基数排序</p>
<p><strong>二.外部排序</strong></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/27/php-cli/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="czhuyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/26237984">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="无限进步">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/27/php-cli/" class="post-title-link" itemprop="http://yoursite.com/index.html">php-cli</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-27 22:26:52" itemprop="dateCreated datePublished" datetime="2019-05-27T22:26:52+08:00">2019-05-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-28 12:16:02" itemprop="dateModified" datetime="2019-05-28T12:16:02+08:00">2019-05-28</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="PHP-CLI"><a href="#PHP-CLI" class="headerlink" title="PHP-CLI"></a>PHP-CLI</h2><p>在命令行输入 php -r “echo 111;” 就可以运行php代码并在控制台得到111的输出，那这中间经历了哪些步骤呢？</p>
<p>从php的github项目中你可以下载到各个版本的源码，这里以5.6.40版本为例</p>
<p>php在命令行的处理源文件在{PHPSRC}/sapi/php_cli.c中</p>
<p>首先跟到main函数(在约1203行)</p>
<p>1378行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">	zend_first_try &#123;</span><br><span class="line">#ifndef PHP_CLI_WIN32_NO_CONSOLE</span><br><span class="line">		if (sapi_module == &amp;cli_sapi_module) &#123;</span><br><span class="line">#endif</span><br><span class="line">			exit_status = do_cli(argc, argv TSRMLS_CC);</span><br><span class="line">#ifndef PHP_CLI_WIN32_NO_CONSOLE</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			exit_status = do_cli_server(argc, argv TSRMLS_CC);</span><br><span class="line">		&#125;</span><br><span class="line">#endif</span><br><span class="line">	&#125; zend_end_try();</span><br></pre></td></tr></table></figure>
<p>这里的do_cli就是具体的实现了，跟到do_cli函数681行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">static int do_cli(int argc, char **argv TSRMLS_DC) /* &#123;&#123;&#123; */</span><br><span class="line">&#123;</span><br><span class="line">	int c;</span><br><span class="line">	......</span><br><span class="line">	char *php_optarg = NULL, *orig_optarg = NULL;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	zend_try &#123;</span><br><span class="line">	</span><br><span class="line">		CG(in_compilation) = 0; /* not initialized but needed for several options */</span><br><span class="line">		EG(uninitialized_zval_ptr) = NULL;</span><br><span class="line"></span><br><span class="line">		while ((c = php_getopt(argc, argv, OPTIONS, &amp;php_optarg, &amp;php_optind, 0, 2)) != -1) &#123;</span><br><span class="line">zend_try &#123;</span><br><span class="line">	</span><br><span class="line">		CG(in_compilation) = 0; /* not initialized but needed for several options */</span><br><span class="line">		EG(uninitialized_zval_ptr) = NULL;</span><br><span class="line"></span><br><span class="line">		while ((c = php_getopt(argc, argv, OPTIONS, &amp;php_optarg, &amp;php_optind, 0, 2)) != -1) &#123;</span><br><span class="line">			switch (c) &#123;</span><br><span class="line"></span><br><span class="line">			......</span><br><span class="line"></span><br><span class="line">			case &apos;v&apos;: /* show php version &amp; quit */</span><br><span class="line">				php_printf(&quot;PHP %s (%s) (built: %s %s) %s\nCopyright (c) 1997-2016 The PHP Group\n%s&quot;,</span><br><span class="line">					PHP_VERSION, cli_sapi_module.name, __DATE__, __TIME__,</span><br><span class="line">#if ZEND_DEBUG &amp;&amp; defined(HAVE_GCOV)</span><br><span class="line">					&quot;(DEBUG GCOV)&quot;,</span><br><span class="line">#elif ZEND_DEBUG</span><br><span class="line">					&quot;(DEBUG)&quot;,</span><br><span class="line">#elif defined(HAVE_GCOV)</span><br><span class="line">					&quot;(GCOV)&quot;,</span><br><span class="line">#else</span><br><span class="line">					&quot;&quot;,</span><br><span class="line">#endif</span><br><span class="line">					get_zend_version()</span><br><span class="line">				);</span><br><span class="line">				sapi_deactivate(TSRMLS_C);</span><br><span class="line">				goto out;</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line">			default:</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		/* Set some CLI defaults */</span><br><span class="line">		SG(options) |= SAPI_OPTION_NO_CHDIR;</span><br><span class="line"></span><br><span class="line">		php_optind = orig_optind;</span><br><span class="line">		php_optarg = orig_optarg;</span><br><span class="line">		while ((c = php_getopt(argc, argv, OPTIONS, &amp;php_optarg, &amp;php_optind, 0, 2)) != -1) &#123;</span><br><span class="line">			switch (c) &#123;</span><br><span class="line"></span><br><span class="line">			......</span><br><span class="line"></span><br><span class="line">			case &apos;r&apos;: /* run code from command line */</span><br><span class="line">				if (behavior == PHP_MODE_CLI_DIRECT) &#123;</span><br><span class="line">					if (exec_direct || script_file) &#123;</span><br><span class="line">						param_error = &quot;You can use -r only once.\n&quot;;</span><br><span class="line">						break;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; else if (behavior != PHP_MODE_STANDARD || interactive) &#123;</span><br><span class="line">					param_error = param_mode_conflict;</span><br><span class="line">					break;</span><br><span class="line">				&#125;</span><br><span class="line">				behavior=PHP_MODE_CLI_DIRECT;</span><br><span class="line">				exec_direct=php_optarg;</span><br><span class="line">				break;</span><br><span class="line">			</span><br><span class="line">			......</span><br><span class="line">			default:</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>这里就见到了我们经常使用的php -v，然后当然还有php -r。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static int do_cli(int argc, char **argv TSRMLS_DC) /* &#123;&#123;&#123; */</span><br></pre></td></tr></table></figure>
<p>这里的argv就是从命令行获取到的内容,我们就跟着这个参数往下查找</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while ((c = php_getopt(argc, argv, OPTIONS, &amp;php_optarg, &amp;php_optind, 0, 2)) != -1) &#123;</span><br></pre></td></tr></table></figure>
<p>686行有这样一部操作，然后我们看到当解析出命令行带了-r参数的时候，最主要做了两步操作</p>
<pre><code>behavior=PHP_MODE_CLI_DIRECT;
exec_direct=php_optarg;
</code></pre><p>所以这里传递引用&amp;php_optarg应该已经赋值了</p>
<p>再往下看会用在什么地方</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">case PHP_MODE_CLI_DIRECT:</span><br><span class="line">	cli_register_file_handles(TSRMLS_C);</span><br><span class="line">	if (zend_eval_string_ex(exec_direct, NULL, &quot;Command line code&quot;, 1 TSRMLS_CC) == FAILURE) &#123;</span><br><span class="line">		exit_status=254;</span><br><span class="line">	&#125;</span><br><span class="line">	break;</span><br></pre></td></tr></table></figure>
<p>然后把参数exec_direct传给zend_eval_string_ex，这个函数的实现在zend_excute_API.c文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">ZEND_API int zend_eval_stringl(char *str, int str_len, zval *retval_ptr, char *string_name TSRMLS_DC) /* &#123;&#123;&#123; */</span><br><span class="line">&#123;</span><br><span class="line">	zval pv;</span><br><span class="line">	zend_op_array *new_op_array;</span><br><span class="line">	zend_op_array *original_active_op_array = EG(active_op_array);</span><br><span class="line">	zend_uint original_compiler_options;</span><br><span class="line">	int retval;</span><br><span class="line"></span><br><span class="line">	if (retval_ptr) &#123;</span><br><span class="line">		Z_STRLEN(pv) = str_len + sizeof(&quot;return ;&quot;) - 1;</span><br><span class="line">		Z_STRVAL(pv) = emalloc(Z_STRLEN(pv) + 1);</span><br><span class="line">		memcpy(Z_STRVAL(pv), &quot;return &quot;, sizeof(&quot;return &quot;) - 1);</span><br><span class="line">		memcpy(Z_STRVAL(pv) + sizeof(&quot;return &quot;) - 1, str, str_len);</span><br><span class="line">		Z_STRVAL(pv)[Z_STRLEN(pv) - 1] = &apos;;&apos;;</span><br><span class="line">		Z_STRVAL(pv)[Z_STRLEN(pv)] = &apos;\0&apos;;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		Z_STRLEN(pv) = str_len;</span><br><span class="line">		Z_STRVAL(pv) = str;</span><br><span class="line">	&#125;</span><br><span class="line">	Z_TYPE(pv) = IS_STRING;</span><br><span class="line"></span><br><span class="line">	/*printf(&quot;Evaluating &apos;%s&apos;\n&quot;, pv.value.str.val);*/</span><br><span class="line"></span><br><span class="line">	original_compiler_options = CG(compiler_options);</span><br><span class="line">	CG(compiler_options) = ZEND_COMPILE_DEFAULT_FOR_EVAL;</span><br><span class="line">	new_op_array = zend_compile_string(&amp;pv, string_name TSRMLS_CC);</span><br><span class="line">	CG(compiler_options) = original_compiler_options;</span><br><span class="line"></span><br><span class="line">	if (new_op_array) &#123;</span><br><span class="line">		zval *local_retval_ptr=NULL;</span><br><span class="line">		zval **original_return_value_ptr_ptr = EG(return_value_ptr_ptr);</span><br><span class="line">		zend_op **original_opline_ptr = EG(opline_ptr);</span><br><span class="line">		int orig_interactive = CG(interactive);</span><br><span class="line"></span><br><span class="line">		EG(return_value_ptr_ptr) = &amp;local_retval_ptr;</span><br><span class="line">		EG(active_op_array) = new_op_array;</span><br><span class="line">		EG(no_extensions)=1;</span><br><span class="line">		if (!EG(active_symbol_table)) &#123;</span><br><span class="line">			zend_rebuild_symbol_table(TSRMLS_C);</span><br><span class="line">		&#125;</span><br><span class="line">		CG(interactive) = 0;</span><br><span class="line"></span><br><span class="line">		zend_try &#123;</span><br><span class="line">			zend_execute(new_op_array TSRMLS_CC);</span><br><span class="line">		&#125; zend_catch &#123;</span><br><span class="line">			destroy_op_array(new_op_array TSRMLS_CC);</span><br><span class="line">			efree(new_op_array);</span><br><span class="line">			zend_bailout();</span><br><span class="line">		&#125; zend_end_try();</span><br><span class="line"></span><br><span class="line">		CG(interactive) = orig_interactive;</span><br><span class="line">		if (local_retval_ptr) &#123;</span><br><span class="line">			if (retval_ptr) &#123;</span><br><span class="line">				COPY_PZVAL_TO_ZVAL(*retval_ptr, local_retval_ptr);</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				zval_ptr_dtor(&amp;local_retval_ptr);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			if (retval_ptr) &#123;</span><br><span class="line">				INIT_ZVAL(*retval_ptr);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		EG(no_extensions)=0;</span><br><span class="line">		EG(opline_ptr) = original_opline_ptr;</span><br><span class="line">		EG(active_op_array) = original_active_op_array;</span><br><span class="line">		destroy_op_array(new_op_array TSRMLS_CC);</span><br><span class="line">		efree(new_op_array);</span><br><span class="line">		EG(return_value_ptr_ptr) = original_return_value_ptr_ptr;</span><br><span class="line">		retval = SUCCESS;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		retval = FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line">	if (retval_ptr) &#123;</span><br><span class="line">		zval_dtor(&amp;pv);</span><br><span class="line">	&#125;</span><br><span class="line">	return retval;</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br><span class="line"></span><br><span class="line">ZEND_API int zend_eval_string(char *str, zval *retval_ptr, char *string_name TSRMLS_DC) /* &#123;&#123;&#123; */</span><br><span class="line">&#123;</span><br><span class="line">	return zend_eval_stringl(str, strlen(str), retval_ptr, string_name TSRMLS_CC);</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br><span class="line"></span><br><span class="line">ZEND_API int zend_eval_stringl_ex(char *str, int str_len, zval *retval_ptr, char *string_name, int handle_exceptions TSRMLS_DC) /* &#123;&#123;&#123; */</span><br><span class="line">&#123;</span><br><span class="line">	int result;</span><br><span class="line"></span><br><span class="line">	result = zend_eval_stringl(str, str_len, retval_ptr, string_name TSRMLS_CC);</span><br><span class="line">	if (handle_exceptions &amp;&amp; EG(exception)) &#123;</span><br><span class="line">		zend_exception_error(EG(exception), E_ERROR TSRMLS_CC);</span><br><span class="line">		result = FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line">	return result;</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br></pre></td></tr></table></figure>
<p>可以看到最后执行的函数就是最上面的zend_eval_stringl</p>
<p>Z_STRVAL(pv) = str;</p>
<p>new_op_array = zend_compile_string(&amp;pv, string_name TSRMLS_CC);</p>
<p>经过词法分析/语法分析</p>
<p>这里得到的new_op_array应该就是包含了opcode的了</p>
<p>有一些比较眼熟的东西</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zend_op_array 这里面会存放需要执行的opcode</span><br><span class="line">EG 和代码的解释相关</span><br><span class="line">CG 和代码的执行相关</span><br><span class="line">zval_dtor</span><br><span class="line">zval_ptr_dtor</span><br></pre></td></tr></table></figure>
<p>EG 和 CG的定义可以在zend_globals_macros.h中可以找到 macro 宏指令的意思，这里就是C语言里面的特性了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/* Compiler */</span><br><span class="line">#ifdef ZTS</span><br><span class="line"># define CG(v) TSRMG(compiler_globals_id, zend_compiler_globals *, v)</span><br><span class="line">int zendparse(void *compiler_globals);</span><br><span class="line">#else</span><br><span class="line"># define CG(v) (compiler_globals.v)</span><br><span class="line">extern ZEND_API struct _zend_compiler_globals compiler_globals;</span><br><span class="line">int zendparse(void);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* Executor */</span><br><span class="line">#ifdef ZTS</span><br><span class="line"># define EG(v) TSRMG(executor_globals_id, zend_executor_globals *, v)</span><br><span class="line">#else</span><br><span class="line"># define EG(v) (executor_globals.v)</span><br><span class="line">extern ZEND_API zend_executor_globals executor_globals;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>zval_dtor和zval_ptr_dtor，我们使用一个unset操作想清除这个变量所占的内存时（可能只是引用计数减一），会从当前符号的哈希表中删除变量名对应的项， 在所有的操作执行完后，并对从符号表中删除的项调用一个析构函数，临时变量会调用zval_dtor，一般的变量会调用zval_ptr_dtor。</p>
<p>zval_ptr_dtor会做的事情就是：如果变量的引用计数为1，即减一后引用计数为0，直接清除变量。如果当前变量如果被缓存，则需要清除缓存；如果变量的引用计数大于1，即减一后引用计数大于0，则将变量放入垃圾列表。如果变量存在引用，则去掉其引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">zend_try &#123;</span><br><span class="line">	zend_execute(new_op_array TSRMLS_CC);</span><br><span class="line">&#125; zend_catch &#123;</span><br><span class="line">	destroy_op_array(new_op_array TSRMLS_CC);</span><br><span class="line">	efree(new_op_array);</span><br><span class="line">	zend_bailout();</span><br><span class="line">&#125; zend_end_try();</span><br></pre></td></tr></table></figure>
<p>这里zend_execute(new_op_array TSRMLS_CC);肯定就是执行new_op_array里面的opcode了。</p>
<p>跟到{PHPSRC}/Zend/zend_vm_execute.h：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">ZEND_API void execute_ex(zend_execute_data *execute_data TSRMLS_DC)</span><br><span class="line">&#123;</span><br><span class="line">	DCL_OPLINE</span><br><span class="line">	zend_bool original_in_execution;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	original_in_execution = EG(in_execution);</span><br><span class="line">	EG(in_execution) = 1;</span><br><span class="line"></span><br><span class="line">	if (0) &#123;</span><br><span class="line">zend_vm_enter:</span><br><span class="line">		execute_data = i_create_execute_data_from_op_array(EG(active_op_array), 1 TSRMLS_CC);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	LOAD_REGS();</span><br><span class="line">	LOAD_OPLINE();</span><br><span class="line"></span><br><span class="line">	while (1) &#123;</span><br><span class="line">    	int ret;</span><br><span class="line">#ifdef ZEND_WIN32</span><br><span class="line">		if (EG(timed_out)) &#123;</span><br><span class="line">			zend_timeout(0);</span><br><span class="line">		&#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">		if ((ret = OPLINE-&gt;handler(execute_data TSRMLS_CC)) &gt; 0) &#123;</span><br><span class="line">			switch (ret) &#123;</span><br><span class="line">				case 1:</span><br><span class="line">					EG(in_execution) = original_in_execution;</span><br><span class="line">					return;</span><br><span class="line">				case 2:</span><br><span class="line">					goto zend_vm_enter;</span><br><span class="line">					break;</span><br><span class="line">				case 3:</span><br><span class="line">					execute_data = EG(current_execute_data);</span><br><span class="line">					break;</span><br><span class="line">				default:</span><br><span class="line">					break;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	zend_error_noreturn(E_ERROR, &quot;Arrived at end of main loop which shouldn&apos;t happen&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ZEND_API void zend_execute(zend_op_array *op_array TSRMLS_DC)</span><br><span class="line">&#123;</span><br><span class="line">	if (EG(exception)) &#123;</span><br><span class="line">		return;</span><br><span class="line">	&#125; </span><br><span class="line">	zend_execute_ex(i_create_execute_data_from_op_array(op_array, 0 TSRMLS_CC) TSRMLS_CC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过while(1)来执行从op_array里拿到的opcode进行执行。</p>
<p>opcode长什么样子呢？</p>
<p>安装一个php扩展vld <a href="http://pecl.php.net/package/vld" target="_blank" rel="noopener">http://pecl.php.net/package/vld</a></p>
<p>安装扩展的方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">phpize </span><br><span class="line">./configure  make &amp;&amp; make install</span><br><span class="line">把编译出来的动态链接库.so文件加到php.ini配置中</span><br><span class="line">vim /usr/local/php/etc/php.ini </span><br><span class="line">service php-fpm restart</span><br><span class="line">php -ini | grep vld</span><br><span class="line">vld</span><br><span class="line">vld support =&gt; enabled</span><br><span class="line">vld.active =&gt; 0 =&gt; 0</span><br><span class="line">vld.col_sep =&gt; 	 =&gt; 	</span><br><span class="line">vld.dump_paths =&gt; 1 =&gt; 1</span><br><span class="line">vld.execute =&gt; 1 =&gt; 1</span><br><span class="line">vld.format =&gt; 0 =&gt; 0</span><br><span class="line">vld.save_dir =&gt; /tmp =&gt; /tmp</span><br><span class="line">vld.save_paths =&gt; 0 =&gt; 0</span><br><span class="line">vld.skip_append =&gt; 0 =&gt; 0</span><br><span class="line">vld.skip_prepend =&gt; 0 =&gt; 0</span><br><span class="line">vld.verbosity =&gt; 1 =&gt; 1</span><br><span class="line">PWD =&gt; /usr/local/src/vld-0.14.0</span><br><span class="line">_SERVER[&quot;PWD&quot;] =&gt; /usr/local/src/vld-0.14.0</span><br></pre></td></tr></table></figure>
<p>看到vld support =&gt; enabled就说明安装成功了</p>
<p>怎么使用呢？<a href="https://derickrethans.nl/projects.html#vld" target="_blank" rel="noopener">https://derickrethans.nl/projects.html#vld</a></p>
<p>在命令行运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r &quot;echo 1111;&quot; -dvld.active=1</span><br></pre></td></tr></table></figure>
<p>我们得到了这样的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1111root@czhuyu-Inspiron-5547:~# php -r &quot;echo 1111;&quot; -dvld.active=1</span><br><span class="line">Finding entry points</span><br><span class="line">Branch analysis from position: 0</span><br><span class="line">Jump found. (Code = 62) Position 1 = -2</span><br><span class="line">filename:       Command line code</span><br><span class="line">function name:  (null)</span><br><span class="line">number of ops:  2</span><br><span class="line">compiled vars:  none</span><br><span class="line">line     #* E I O op                           fetch          ext  return  operands</span><br><span class="line">-------------------------------------------------------------------------------------</span><br><span class="line">   1     0  E &gt;   ECHO                                                     1111</span><br><span class="line">         1      &gt; RETURN                                                   null</span><br><span class="line"></span><br><span class="line">branch: #  0; line:     1-    1; sop:     0; eop:     1; out1:  -2</span><br><span class="line">path #1: 0, </span><br><span class="line">1111</span><br></pre></td></tr></table></figure>
<p>其中关键的部分应该就是这个op列下面的ECHO了</p>
<p>ECHO对应到源码中执行的操作就是ZEND_ECHO_SPEC_CONST_HANDLER</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">static int ZEND_FASTCALL  ZEND_ECHO_SPEC_CONST_HANDLER(ZEND_OPCODE_HANDLER_ARGS)</span><br><span class="line">&#123;</span><br><span class="line">	USE_OPLINE</span><br><span class="line"></span><br><span class="line">	zval *z;</span><br><span class="line"></span><br><span class="line">	SAVE_OPLINE();</span><br><span class="line">	z = opline-&gt;op1.zv;</span><br><span class="line"></span><br><span class="line">	if (IS_CONST == IS_TMP_VAR &amp;&amp; Z_TYPE_P(z) == IS_OBJECT) &#123;</span><br><span class="line">		INIT_PZVAL(z);</span><br><span class="line">	&#125;</span><br><span class="line">	zend_print_variable(z);</span><br><span class="line"></span><br><span class="line">	CHECK_EXCEPTION();</span><br><span class="line">	ZEND_VM_NEXT_OPCODE();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ZEND_API int zend_print_variable(zval *var) </span><br><span class="line">&#123;</span><br><span class="line">	return zend_print_zval(var, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ZEND_API int zend_print_zval(zval *expr, int indent) /* &#123;&#123;&#123; */</span><br><span class="line">&#123;</span><br><span class="line">	return zend_print_zval_ex(zend_write, expr, indent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ZEND_API int zend_print_zval_ex(zend_write_func_t write_func, zval *expr, int indent) /* &#123;&#123;&#123; */</span><br><span class="line">&#123;</span><br><span class="line">	zval expr_copy;</span><br><span class="line">	int use_copy;</span><br><span class="line"></span><br><span class="line">	zend_make_printable_zval(expr, &amp;expr_copy, &amp;use_copy);</span><br><span class="line">	if (use_copy) &#123;</span><br><span class="line">		expr = &amp;expr_copy;</span><br><span class="line">	&#125;</span><br><span class="line">	if (Z_STRLEN_P(expr) == 0) &#123; /* optimize away empty strings */</span><br><span class="line">		if (use_copy) &#123;</span><br><span class="line">			zval_dtor(expr);</span><br><span class="line">		&#125;</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line">	write_func(Z_STRVAL_P(expr), Z_STRLEN_P(expr));</span><br><span class="line">	if (use_copy) &#123;</span><br><span class="line">		zval_dtor(expr);</span><br><span class="line">	&#125;</span><br><span class="line">	return Z_STRLEN_P(expr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个write_func应该就是执行输出操作了</p>
<p>最后调用到的就是sapi_cli_single_write</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">PHP_CLI_API size_t sapi_cli_single_write(const char *str, uint str_length TSRMLS_DC) /* &#123;&#123;&#123; */</span><br><span class="line">&#123;</span><br><span class="line">#ifdef PHP_WRITE_STDOUT</span><br><span class="line">	long ret;</span><br><span class="line">#else</span><br><span class="line">	size_t ret;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	if (cli_shell_callbacks.cli_shell_write) &#123;</span><br><span class="line">		size_t shell_wrote;</span><br><span class="line">		shell_wrote = cli_shell_callbacks.cli_shell_write(str, str_length TSRMLS_CC);</span><br><span class="line">		if (shell_wrote &gt; -1) &#123;</span><br><span class="line">			return shell_wrote;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">#ifdef PHP_WRITE_STDOUT</span><br><span class="line">	do &#123;</span><br><span class="line">		ret = write(STDOUT_FILENO, str, str_length);</span><br><span class="line">	&#125; while (ret &lt;= 0 &amp;&amp; errno == EAGAIN &amp;&amp; sapi_cli_select(STDOUT_FILENO TSRMLS_CC));</span><br><span class="line"></span><br><span class="line">	if (ret &lt;= 0) &#123;</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return ret;</span><br><span class="line">#else</span><br><span class="line">	ret = fwrite(str, 1, MIN(str_length, 16384), stdout);</span><br><span class="line">	return ret;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br></pre></td></tr></table></figure>
<p>我们都知道输出到控制台属于标准输出那肯定就是调用了write这个函数了</p>
<p>c语言的write函数是可以直接把内容输出到控制台的，至此，一个大概的流程就走完了，当然中间还有很多没有讲得很清楚的地方或许还有有错的地方，需要再看下文档，再梳理完善。</p>
<p>参考资料</p>
<ol>
<li><a href="https://github.com/php/php-src/tree/PHP-5.6.40" target="_blank" rel="noopener">https://github.com/php/php-src/tree/PHP-5.6.40</a></li>
<li><a href="http://www.php-internals.com/" target="_blank" rel="noopener">http://www.php-internals.com/</a></li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/26/php内存管理与资源管理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="czhuyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/26237984">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="无限进步">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/26/php内存管理与资源管理/" class="post-title-link" itemprop="http://yoursite.com/index.html">php内存管理与资源管理</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-26 16:18:56" itemprop="dateCreated datePublished" datetime="2019-05-26T16:18:56+08:00">2019-05-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-28 15:47:36" itemprop="dateModified" datetime="2019-05-28T15:47:36+08:00">2019-05-28</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="php内存管理与资源管理"><a href="#php内存管理与资源管理" class="headerlink" title="php内存管理与资源管理"></a>php内存管理与资源管理</h2><h3 id="一-内存管理"><a href="#一-内存管理" class="headerlink" title="一.内存管理"></a>一.内存管理</h3><h5 id="1-php5-3垃圾回收机制"><a href="#1-php5-3垃圾回收机制" class="headerlink" title="1.php5.3垃圾回收机制"></a>1.php5.3垃圾回收机制</h5><p><strong>引用计数</strong></p>
<p><a href="https://www.php.net/manual/zh/features.gc.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/features.gc.php</a><br>在c中,<br>​    函数的参数和局部变量保存在栈上  由编译器自动分配释放<br>​    malloc函数分来内存在堆上  需要手动使用free来释放</p>
<p>在php中,</p>
<p>每个php变量存在一个叫”zval”的变量容器中。每当一个变量被赋常量值的时候，就会生成下面zval这样的变量容器，一个_zval_struct结构体。而最终垃圾回收销毁的也是这样的变量容器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">typedef union _zvalue_value &#123;</span><br><span class="line">	long lval;					/* long value */</span><br><span class="line">	double dval;				/* double value */</span><br><span class="line">	struct &#123;</span><br><span class="line">		char *val;</span><br><span class="line">		int len;</span><br><span class="line">	&#125; str;</span><br><span class="line">	HashTable *ht;				/* hash table value */</span><br><span class="line">	zend_object_value obj;</span><br><span class="line">	zend_ast *ast;</span><br><span class="line">&#125; zvalue_value;</span><br><span class="line"></span><br><span class="line">struct _zval_struct &#123;</span><br><span class="line">	/* Variable information */</span><br><span class="line">	zvalue_value value;		/* value */</span><br><span class="line">	zend_uint refcount__gc;</span><br><span class="line">	zend_uchar type;	/* active type */</span><br><span class="line">	zend_uchar is_ref__gc;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>简单类型的引用计数原理<br>refcount__gc这个就是用以表示指向这个zval变量容器的变量(也称符号即symbol)个数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = &quot;new string&quot;;</span><br></pre></td></tr></table></figure>
<p>因为$a使用了这个变量的容器，所以zval的refcount的值用xdebug_debug_zval打印出来会是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a: (refcount=1, is_ref=0)=&apos;new string&apos;</span><br></pre></td></tr></table></figure>
<p>把一个变量赋值给另一变量将增加引用次数(refcount).，也就当$a被赋值给其他变量的时候这个refcount会增加。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = &quot;new string&quot;;</span><br><span class="line">$c = $b = $a;</span><br><span class="line">xdebug_debug_zval( &apos;a&apos; );</span><br><span class="line">unset( $b, $c );</span><br><span class="line">xdebug_debug_zval( &apos;a&apos; );</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>当然第一个打印出来的a的refcount会是3，当任何关联到某个变量容器的变量离开它的作用域(比如：函数执行结束)，或者对变量调用了函数 <a href="https://www.php.net/manual/zh/function.unset.php" target="_blank" rel="noopener">unset()</a>时，”refcount“就会减1，所以第二个打印出来的a的refcount会是1。变量容器在”refcount“变成0时就被销毁</p>
<p>垃圾回收是为了解决内存泄露的问题,内存泄露指的是在程序申请了内存使用后而没有释放,最终导致内存消耗殆尽<br>还有个名词叫做内存溢出 指的是只申请了int大的内存空间,却往里面存储long类型的数据。</p>
<p>这样就能保证不会产生内存泄漏了吗？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $a = [&apos;one&apos;];</span><br><span class="line">    $a[] = &amp;$a;</span><br><span class="line">    xdebug_debug_zval(&apos;a&apos;);</span><br><span class="line">    unset($a);</span><br><span class="line">    xdebug_debug_zval(&apos;a&apos;);</span><br></pre></td></tr></table></figure>
<p>第一个xdebug的结果是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a:</span><br><span class="line">(refcount=2, is_ref=1),</span><br><span class="line">array (size=2)</span><br><span class="line">  0 =&gt; (refcount=1, is_ref=0),string &apos;one&apos; (length=3)</span><br><span class="line">  1 =&gt; (refcount=2, is_ref=1),</span><br><span class="line">    &amp;array&lt;</span><br></pre></td></tr></table></figure>
<p>第二个xdebug打印出来的结果会是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a: no such symbol</span><br></pre></td></tr></table></figure>
<p>$a已经不在符号表了，但是数组的refcount变为的是1，还是会导致内存泄漏。这种怎么处理呢？这里就要讲下一个概念了：</p>
<p><strong>回收周期</strong></p>
<p>这是php手册中关于回收周期的图</p>
<p><img src="https://www.php.net/manual/zh/images/12f37b1c6963c1c5c18f30495416a197-gc-algorithm.png" alt=""></p>
<p>我们使用一个unset操作想清除这个变量所占的内存时（可能只是引用计数减一），会从当前符号的哈希表中删除变量名对应的项， 在所有的操作执行完后，并对从符号表中删除的项调用一个析构函数，临时变量会调用zval_dtor，一般的变量会调用zval_ptr_dtor。</p>
<p>zval_ptr_dtor会做的事情就是：如果变量的引用计数为1，即减一后引用计数为0，直接清除变量。如果当前变量如果被缓存，则需要清除缓存；如果变量的引用计数大于1，即减一后引用计数大于0，则将变量放入垃圾列表。如果变量存在引用，则去掉其引用。</p>
<p>垃圾列表满时（10000个gc_root_buffer内存空间），调用gc_collect_cycles函数</p>
<p>步骤 B ，算法使用深度优先搜索查找所有可能的根，找到后将每个变量容器中的引用计数减1， 为确保不会对同一个变量容器减两次“1”，用灰色标记已减过1的。</p>
<p>步骤 C ，算法再一次对每个根节点使用深度优先搜索，检查每个变量容器的引用计数。 如果引用计数是 0 ，变量容器用白色来标记。如果引用次数大于0，则恢复在这个点上使用深度优先搜索而将引用计数减1的操作（即引用计数加1）， 然后将它们重新用黑色标记。</p>
<p>最后一步 D ，算法遍历根缓冲区以从那里删除变量容器根(zval roots)， 同时，检查是否有在上一步中被白色标记的变量容器。每个被白色标记的变量容器都被清除。</p>
<h5 id="2-写时复制"><a href="#2-写时复制" class="headerlink" title="2.写时复制"></a>2.写时复制</h5><p>写时复制并不是PHP独有的</p>
<h5 id="3-慎用-amp"><a href="#3-慎用-amp" class="headerlink" title="3.慎用&amp;"></a>3.慎用&amp;</h5><h3 id="二-资源管理"><a href="#二-资源管理" class="headerlink" title="二.资源管理"></a>二.资源管理</h3><p><strong>数据库资源为例：</strong><br>​        在java里面，会在try cache的finally结构中调用一个connection.close()去显式地关闭数据库的连接<br>​        在c++里面可以用__destruct析构函数在对象被销毁的时候来做close的操作<br>​        在php中呢？日常开发使用laravel框架的时候好像没注意到这个地方，也没有去显式地调用close方法.但肯定是有close的方法来提前释放掉这个连接的，laravel的数据库操作的实现是基于PDO来做的。<br>​        通过查阅文档<a href="https://www.php.net/manual/zh/pdo.connections.php，连接数据成功后，返回一个" target="_blank" rel="noopener">https://www.php.net/manual/zh/pdo.connections.php，连接数据成功后，返回一个</a> PDO 类的实例给脚本，此连接在 PDO 对象的生存周期中保持活动。要想关闭连接，需要销毁对象以确保所有剩余到它的引用都被删除，可以赋一个 NULL 值给对象变量。如果不明确地这么做，PHP 在脚本结束时会自动关闭连接                                                                                                                                                                                                                                                                                                                                                                                                                                         </p>
<h3 id="三-其他"><a href="#三-其他" class="headerlink" title="三.其他"></a>三.其他</h3><h5 id="1-符号表"><a href="#1-符号表" class="headerlink" title="1.符号表"></a>1.符号表</h5><p><strong>参考资料：</strong></p>
<p>1.php官方手册</p>
<p>2.<a href="http://www.php-internals.com/book/?p=chapt06/06-04-00-garbage-collection" target="_blank" rel="noopener">http://www.php-internals.com/book/?p=chapt06/06-04-00-garbage-collection</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/24/leetcode-15/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="czhuyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/26237984">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="无限进步">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/24/leetcode-15/" class="post-title-link" itemprop="http://yoursite.com/index.html">leetcode-15</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-24 22:37:52 / 修改时间：23:53:17" itemprop="dateCreated datePublished" datetime="2019-05-24T22:37:52+08:00">2019-05-24</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="leetcode-15"><a href="#leetcode-15" class="headerlink" title="leetcode-15"></a>leetcode-15</h2><p>给定一个包含 <em>n</em> 个整数的数组 <code>nums</code>，判断 <code>nums</code> 中是否存在三个元素 <em>a，b，c ，</em>使得 <em>a + b + c =</em> 0 ？找出所有满足条件且不重复的三元组。</p>
<p><strong>注意：</strong>答案中不可以包含重复的三元组。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">例如, 给定数组 nums = [-1, 0, 1, 2, -1, -4]，</span><br><span class="line"></span><br><span class="line">满足要求的三元组集合为：</span><br><span class="line">[</span><br><span class="line">  [-1, 0, 1],</span><br><span class="line">  [-1, -1, 2]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>解答</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">threeSum</span><span class="params">(nums []<span class="keyword">int</span>)</span> [][]<span class="title">int</span></span> &#123;</span><br><span class="line">	sort.Ints(nums)</span><br><span class="line">	<span class="built_in">len</span> := <span class="built_in">len</span>(nums)</span><br><span class="line">	<span class="keyword">var</span> res [][]<span class="keyword">int</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="built_in">len</span>; j++ &#123;</span><br><span class="line">			<span class="keyword">for</span> k := <span class="number">0</span>; k &lt; <span class="built_in">len</span>; k++ &#123;</span><br><span class="line">				<span class="keyword">if</span> nums[i]+nums[j]+nums[k] == <span class="number">0</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> i &lt; j &amp;&amp; j &lt; k &#123;</span><br><span class="line">						tmpNums := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line">						tmpNums[<span class="number">0</span>] = nums[i]</span><br><span class="line">						tmpNums[<span class="number">1</span>] = nums[j]</span><br><span class="line">						tmpNums[<span class="number">2</span>] = nums[k]</span><br><span class="line">						res = <span class="built_in">append</span>(res, tmpNums)</span><br><span class="line">						<span class="keyword">if</span> nums[i] == nums[i+<span class="number">1</span>] &#123;</span><br><span class="line">							i++</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/24/ubuntu/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="czhuyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/26237984">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="无限进步">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/24/ubuntu/" class="post-title-link" itemprop="http://yoursite.com/index.html">ubuntu</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-24 11:03:06 / 修改时间：11:29:18" itemprop="dateCreated datePublished" datetime="2019-05-24T11:03:06+08:00">2019-05-24</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="淘汰笔记本的利用"><a href="#淘汰笔记本的利用" class="headerlink" title="淘汰笔记本的利用"></a>淘汰笔记本的利用</h2><p>之前用的笔记本是dell5547，由于性能等各方面原因闲置下来了，当时还给它换了块固态硬盘，买的时候还是比较贵的，感觉扔了又比较可惜，于是打算安装个linux发行版在上面做服务器。</p>
<p><strong>第一个问题是安装什么发行版本，centos还是ubuntu</strong></p>
<p>​        之前用过最多的还是centos这类的发行版，因为考虑到可以体验下gnome的桌面环境可以使用浏览器/phpstorm啥的再加上……(其实是因为安装centos遇到了显卡驱动的问题反正网上是这么说的，在安装系统时卡住了，搜了很多没有解决)。</p>
<p>​    对我而言redhat和debain系目前使用上最大的区别就是一个用yum来安装一个用apt-get。</p>
<p><strong>下载Ubuntu 18.04.2 LTS (long time support?)</strong></p>
<p><strong>下载ultraiso</strong> 把系统写进u盘（第一步打开镜像iso文件 第二步写入硬盘），什么？要收费？试用30天！</p>
<p>然后在笔记本开机的时候疯狂摁fn+f12（进入快捷选择启动盘），fn+f2进入boot引导设置界面.dell应该都是这样的，其他机型baidu/google.然后选择u盘，然后图形界面安装完成</p>
<p><strong>ssh</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install openssh-server</span><br><span class="line">service ssh start</span><br></pre></td></tr></table></figure>
<p><strong>因为是用来作服务器，所以想让它启动就进入命令行模式</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/default/grub</span><br><span class="line">把这行 GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash&quot;</span><br><span class="line">改成   GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash 3&quot;</span><br><span class="line">update-grub</span><br></pre></td></tr></table></figure>
<p><strong>重启进入命令行模式</strong></p>
<p><strong>然后把笔记本盖子关上（减小功耗），ssh断了???</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/logind.conf</span><br><span class="line">	HandleLidSwitch 这个变量是用来控制合上盖子的系统操作的</span><br><span class="line">	我们把它的值改成 &quot;lock&quot;(锁屏)</span><br><span class="line">systemctl restart systemd-logind</span><br></pre></td></tr></table></figure>
<p>然后就可以让它安静地做一个服务器了，你可以在上面安装lnmp……</p>
<p><strong>最后一个问题，查看电量</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /sys/ -name capacity -exec cat &#123;&#125; \;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/21/mysql查询优化/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="czhuyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/26237984">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="无限进步">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/21/mysql查询优化/" class="post-title-link" itemprop="http://yoursite.com/index.html">mysql查询优化</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-21 21:57:03" itemprop="dateCreated datePublished" datetime="2019-05-21T21:57:03+08:00">2019-05-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-24 17:33:14" itemprop="dateModified" datetime="2019-05-24T17:33:14+08:00">2019-05-24</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="mysql-查询优化"><a href="#mysql-查询优化" class="headerlink" title="mysql 查询优化"></a>mysql 查询优化</h2><h3 id="一-使用explain分析sql索引使用情况"><a href="#一-使用explain分析sql索引使用情况" class="headerlink" title="一.使用explain分析sql索引使用情况"></a>一.使用explain分析sql索引使用情况</h3><p>有如下表结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `index_test` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(255) NOT NULL,</span><br><span class="line">  `age` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain SELECT * FROM `index_test` WHERE id = 1;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>SIMPLE</td>
<td>index_test</td>
<td>const</td>
<td>PRIMARY</td>
<td>PRIMARY</td>
<td>4</td>
<td>const</td>
<td>1</td>
</tr>
</tbody>
</table>
<p><strong>id</strong> 唯一查询标识符</p>
<p><strong>select_type</strong> SIMPLE/PRIMARY/UNION/SUBQUERY</p>
<p><strong>table</strong> 表名</p>
<p><strong>type</strong> 类型</p>
<p>​    The type column of EXPLAIN output describes how tables are joined. In JSON-formatted output,<br>these are found as values of the access_type property. The following list describes the join types    </p>
<p>​    效率从高到低</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</span><br></pre></td></tr></table></figure>
<p>​    const 主键或者唯一索引的等值查询</p>
<p>​    index 会扫描所有的索引</p>
<p>​    ref 通过特殊查找(即不会扫描所有索引)</p>
<p>​    all 扫描全表</p>
<p>​        EXPLAIN SELECT * FROM <code>index_test</code> where <code>name</code> like ‘%a%’;</p>
<p>​    range 范围查询 </p>
<p>​        EXPLAIN SELECT * FROM <code>index_test</code> where id &gt; 1;</p>
<p>​        EXPLAIN SELECT * FROM <code>index_test</code> where <code>name</code> like ‘a%’;</p>
<p><strong>possible_keys</strong>   能够用到的索引，但可能在具体查询时并没有用到</p>
<p>​    eg:给上表再增加一个普通索引   ADD INDEX <code>idx_name</code> (<code>name</code>) ;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM `index_test` where id = 1 and `name` = &apos;aaa&apos;;</span><br><span class="line">这里将会看到possible_keys为PRIMARY,idx_name，但实际上key为PRIMARY</span><br></pre></td></tr></table></figure>
<p><strong>key</strong>   当前查询使用到的索引</p>
<p><strong>key_len</strong>   索引使用的字节数</p>
<p>​     表示查询优化器使用了索引的字节数. 这个字段可以评估组合索引是否完全被使用, 或只有最左部分字段被使用到.</p>
<p><strong>ref</strong></p>
<p>​    The ref column shows which columns or constants are compared to the index named in the key<br>column to select rows from the table.    </p>
<p><strong>rows</strong> 需要扫描的行数</p>
<p>​    在实际查询过程中，此值一般越小越好</p>
<p><strong>Extra</strong> 额外</p>
<p>​    当所查询的字段在索引树上可以直接找到 会展示Using index</p>
<h3 id="二-其他语句查询索引使用情况"><a href="#二-其他语句查询索引使用情况" class="headerlink" title="二.其他语句查询索引使用情况"></a>二.其他语句查询索引使用情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show status like &apos;%Handler_read%&apos;;</span><br><span class="line">select * from schema_unused_indexes;</span><br></pre></td></tr></table></figure>
<h3 id="三-索引的最左匹配原则"><a href="#三-索引的最左匹配原则" class="headerlink" title="三.索引的最左匹配原则"></a>三.索引的最左匹配原则</h3><p><strong>1.是什么</strong></p>
<p>最左匹配是在复合索引中出现的概念</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD INDEX `idx_col1_col2_col3` (`col1`, `col2`, `col3`) ;</span><br></pre></td></tr></table></figure>
<p>需要先使用最左边的索引才能继续使用第二个索引，以此类推</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM tbl_name WHERE col1=val1;</span><br><span class="line">SELECT * FROM tbl_name WHERE col1=val1 AND col2=val2;</span><br><span class="line"></span><br><span class="line">SELECT * FROM tbl_name WHERE col2=val2;</span><br><span class="line">SELECT * FROM tbl_name WHERE col2=val2 AND col3=val3;</span><br></pre></td></tr></table></figure>
<p>上面四句sql,1,2句会用到索引，而3,4句不会用到。</p>
<p>至于条件先后，mysql会做查询优化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">eg:</span><br><span class="line">explain SELECT * FROM `index_test` where age = 20 and `name` = &apos;ccc&apos;;</span><br><span class="line">explain SELECT * FROM `index_test` where `name` = &apos;ccc&apos; and age = 20;</span><br><span class="line">这两句sql的explain结果是一致的</span><br></pre></td></tr></table></figure>
<p><strong>2.为什么</strong></p>
<p>mysql的B-tree索引树的数据结构决定了构建三个字段索引的时候只能保持第一个字段有序的时候才能保证第二个有序，然后才能保证第三个有序。</p>
<p>那是什么样的数据结构呢？</p>
<p>结构猜想：</p>
<p>树的整棵索引树的根节点上是col1组成的B-tree树,当根节点的值相等的时候（也就是col1相等的时候）又会在此节点上再新建根节点是col2组成的B-tree树，以此类推，所以当有联合索引的查找开始的时候，先依据col1找到相对应的类似于子树的地方再根据col2,col3去查找，为什么这样就会快呢？因为在这样的树上查找到该节点的时候会用到的就是二分查找（折半查找 O(log2n)）。</p>
<p>有点类似于orderBy col1 orderBy col2 orderBy col3。</p>
<p><strong>3.引申</strong></p>
<p>复合索引：建立在多列上的索引</p>
<p>单列索引：建立在某一列上的索引</p>
<p>复合索引的</p>
<p>优点：</p>
<p>1.建立一个索引可以用于多处 （col1,col2）和 col1这种条件都能用到</p>
<p>缺点：</p>
<p>1.使用有局限性，最左匹配</p>
<p>2.插入数据后索引树建立相对单列索引肯定是更复杂的，整体而言占用的空间肯定也更大。</p>
<h3 id="四-其他"><a href="#四-其他" class="headerlink" title="四.其他"></a>四.其他</h3><p>1.数据库三范式</p>
<p>1NF：每个列原子性/不可再分</p>
<p>2NF：非主键字段完全依赖于主键而不是依赖于主键的一部分</p>
<p>3NF : 非主键字段需要直接依赖于主键而不是间接依赖</p>
<p>2.临时表</p>
<p>3.filesort</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/18/Laravel中的设计模式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="czhuyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/26237984">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="无限进步">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/18/Laravel中的设计模式/" class="post-title-link" itemprop="http://yoursite.com/index.html">Laravel中的设计模式</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-18 17:34:16" itemprop="dateCreated datePublished" datetime="2019-05-18T17:34:16+08:00">2019-05-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-20 22:47:23" itemprop="dateModified" datetime="2019-05-20T22:47:23+08:00">2019-05-20</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Laravel中的设计模式"><a href="#Laravel中的设计模式" class="headerlink" title="Laravel中的设计模式"></a>Laravel中的设计模式</h2><h4 id="一、外观-门面模式"><a href="#一、外观-门面模式" class="headerlink" title="一、外观/门面模式"></a>一、外观/门面模式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">为子系统中的一组接口提供一个一致的界面，Facade模式定义了一个高层次的接口，使得子系统更加容易使用</span><br><span class="line">外部与子系统的通信是通过一个门面(Facade)对象进行</span><br></pre></td></tr></table></figure>
<p>​     在laravel中，我们可以通过Log::info / Cache::add/Route::get这样的静态方法来记录日志或者新增缓存或者路由定义,这一类方法的调用都可以使用一致的静态方法调用方式来调用.</p>
<p>以Log::info为例的运行流程</p>
<ol>
<li>config/app.php</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&apos;aliases&apos; =&gt; [</span><br><span class="line">	Log&apos;       =&gt; Illuminate\Support\Facades\Log::class,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>vendor/laravel/framework/src/Illuminate/Support/Facades/Log.php</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace Illuminate\Support\Facades;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @see \Illuminate\Log\Writer</span><br><span class="line"> */</span><br><span class="line">class Log extends Facade</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * Get the registered name of the component.</span><br><span class="line">     *</span><br><span class="line">     * @return string</span><br><span class="line">     */</span><br><span class="line">    protected static function getFacadeAccessor()</span><br><span class="line">    &#123;</span><br><span class="line">        return &apos;log&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>从上面可以看到Log里面没有info这个静态方法，然后查看extends的Facade<br>__callStatic()魔术方法 当被调用的对象没有这个static方法时就会先执行此方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public static function __callStatic($method, $args)</span><br><span class="line">    &#123;</span><br><span class="line">        $instance = static::getFacadeRoot();</span><br><span class="line"></span><br><span class="line">        if (! $instance) &#123;</span><br><span class="line">            throw new RuntimeException(&apos;A facade root has not been set.&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        switch (count($args)) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                return $instance-&gt;$method();</span><br><span class="line">            case 1:</span><br><span class="line">                return $instance-&gt;$method($args[0]);</span><br><span class="line">            case 2:</span><br><span class="line">                return $instance-&gt;$method($args[0], $args[1]);</span><br><span class="line">            case 3:</span><br><span class="line">                return $instance-&gt;$method($args[0], $args[1], $args[2]);</span><br><span class="line">            case 4:</span><br><span class="line">                return $instance-&gt;$method($args[0], $args[1], $args[2], $args[3]);</span><br><span class="line">            default:</span><br><span class="line">                return call_user_func_array([$instance, $method], $args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>那Log最终new的实例是什么呢</p>
</li>
<li><p>vendor/laravel/framework/src/Illuminate/Log/LogServiceProvider.php</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Register the service provider.</span><br><span class="line"> *</span><br><span class="line"> * @return void</span><br><span class="line"> */</span><br><span class="line">public function register()</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;app-&gt;singleton(&apos;log&apos;, function () &#123;</span><br><span class="line">        return $this-&gt;createLogger();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">/**</span><br><span class="line"> * Create the logger.</span><br><span class="line"> *</span><br><span class="line"> * @return \Illuminate\Log\Writer</span><br><span class="line"> */</span><br><span class="line">public function createLogger()</span><br><span class="line">&#123;</span><br><span class="line">    $log = new Writer(</span><br><span class="line">        new Monolog($this-&gt;channel()), $this-&gt;app[&apos;events&apos;]</span><br><span class="line">    );</span><br><span class="line">   </span><br><span class="line">    if ($this-&gt;app-&gt;hasMonologConfigurator()) &#123;</span><br><span class="line">        call_user_func($this-&gt;app-&gt;getMonologConfigurator(), $log-&gt;getMonolog());</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $this-&gt;configureHandler($log);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    return $log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li><p>最终调用到的就是</p>
<p>vendor/laravel/framework/src/Illuminate/Log/Writer.php</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Log an informational message to the logs.</span><br><span class="line"> *</span><br><span class="line"> * @param  string  $message</span><br><span class="line"> * @param  array  $context</span><br><span class="line"> * @return void</span><br><span class="line"> */</span><br><span class="line">public function info($message, array $context = [])</span><br><span class="line">&#123;</span><br><span class="line">    return $this-&gt;writeLog(__FUNCTION__, $message, $context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/18/加密相关/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="czhuyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/26237984">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="无限进步">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/18/加密相关/" class="post-title-link" itemprop="http://yoursite.com/index.html">加密相关</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-18 17:34:02" itemprop="dateCreated datePublished" datetime="2019-05-18T17:34:02+08:00">2019-05-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-20 23:09:58" itemprop="dateModified" datetime="2019-05-20T23:09:58+08:00">2019-05-20</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="加密相关"><a href="#加密相关" class="headerlink" title="加密相关"></a>加密相关</h2><h4 id="一-对称加密"><a href="#一-对称加密" class="headerlink" title="一.对称加密"></a>一.对称加密</h4><p>1.使用相同的密钥来进行加密解密</p>
<p>2.优缺点：计算小、加密快/不够安全</p>
<p>3.eg: AES</p>
<h4 id="二-非对称加密"><a href="#二-非对称加密" class="headerlink" title="二.非对称加密"></a>二.非对称加密</h4><p>1.公钥和私钥 公钥加密私钥解密/私钥加密公钥解密</p>
<p>2.优缺点：安全性高/加解密时间长、速度慢</p>
<p>3.eg:RSA</p>
<h4 id="三-签名-摘要"><a href="#三-签名-摘要" class="headerlink" title="三.签名/摘要"></a>三.签名/摘要</h4><p>eg:MD5</p>
<h4 id="四-https"><a href="#四-https" class="headerlink" title="四.https"></a>四.https</h4><p>https使用对称加密和非对称加密同时使用集合两者优点</p>
<p><img src="http://139.224.239.61/20190520.png" alt="1558364728133"></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/18/awk相关/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="czhuyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/26237984">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="无限进步">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/18/awk相关/" class="post-title-link" itemprop="http://yoursite.com/index.html">awk相关</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-18 17:33:41" itemprop="dateCreated datePublished" datetime="2019-05-18T17:33:41+08:00">2019-05-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-20 22:21:15" itemprop="dateModified" datetime="2019-05-20T22:21:15+08:00">2019-05-20</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="awk相关"><a href="#awk相关" class="headerlink" title="awk相关"></a>awk相关</h2><ol>
<li><p>统计nginx access_log中访问频率排前十的ip/URL etc</p>
<p>awk ‘{print $1}’ access.log | sort | uniq -c | sort -nr -k1 | head -n 10</p>
<p>sort 让整个文件内容按行排序  相同内容的行会聚集到相邻的位置</p>
<p>uniq -c  去除重复列并且把重复次数产生新的一列展示到最前面</p>
<p>sort -nr -k1 把第一列的结果按照数字大小倒序排列</p>
<p>head -n 10 展示前十条</p>
<p>根据日志的格式调整print的列即可获取不同结果</p>
</li>
<li><p>列出当前目录下的所有文件</p>
<p>ls -lR |grep -v ^d|awk ‘{print $9}’ |tr -s ‘\n’</p>
</li>
<li></li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/25/MySQL存储引擎和索引结构/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="czhuyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/26237984">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="无限进步">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/25/MySQL存储引擎和索引结构/" class="post-title-link" itemprop="http://yoursite.com/index.html">MySQL存储引擎和索引结构</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-25 21:10:47" itemprop="dateCreated datePublished" datetime="2019-04-25T21:10:47+08:00">2019-04-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-21 21:56:03" itemprop="dateModified" datetime="2019-05-21T21:56:03+08:00">2019-05-21</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一、数据结构</p>
<p>​    MySQL的索引方法</p>
<ol>
<li>B-tree<ol>
<li>快速查找使用等于不等于条件或者范围（&gt;/&lt;/BETWEEN）条件的情形。</li>
</ol>
</li>
<li>hash<ol>
<li>只适用于MySQL的MEMORY存储引擎</li>
</ol>
</li>
</ol>
<p>二、MySQL （5.6为例）不同存储引擎的索引结构差别</p>
<p>​    这里讨论MySQL两种主要的存储引擎InnoDB 和 MyISAM</p>
<ol>
<li>InnoDB<ol>
<li>每一个InnoDB都会有一个索引叫做聚集索引(<a href="https://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_clustered_index" target="_blank" rel="noopener">clustered index</a>)，通常这个索引也是主键（primary key），数据文件按主键聚集。每个索引的数据都会存在于此索引结构的树上。</li>
<li>每一个第二索引(Secondary Indexes)都会有一个字段来存储主键来关联上数据。</li>
<li>所有的InnoDB索引都是用B-trees,所有的索引记录都存在树的叶子结点。默认索引页大小为16KB。</li>
</ol>
</li>
<li>MyISAM<ol>
<li>MySQL5.6版本之后默认存储引擎为InnoDB，如果需要MyISAM则需要在建表语句中指定。</li>
<li>同样支持B-tree索引、不支持聚集索引、不支持HASH索引。采用非聚集索引。</li>
<li>Primary Key和Secondary Key在结构上是一致的。MyISAM的索引文件不同之处在于Primary Key的key要求是唯一的，而Secondary Key的key可以重复。</li>
<li>和InnoDB的结构不同之处在于MyISAM的每个索引树的叶子节点存储的是数据的地址，索引文件数据文件分离。</li>
</ol>
</li>
</ol>
<p>三、BTREE树搜索算法</p>
<p>四、其他</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://avatars2.githubusercontent.com/u/26237984" alt="czhuyu">
            
              <p class="site-author-name" itemprop="name">czhuyu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">46</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">czhuyu</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.6.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.6.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
